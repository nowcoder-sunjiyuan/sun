# MySQL并发控制核心总结 (RC与RR级别对比)

> 本文是对MySQL中两种核心事务隔离级别——读已提交（Read Committed, RC）和可重复读（Repeatable Read, RR）——在并发控制策略上差异的精炼总结。

<details>
<summary>目录</summary>

- [MySQL并发控制核心总结 (RC与RR级别对比)](#mysql并发控制核心总结-rc与rr级别对比)
  - [一、 两大核心并发控制机制](#一-两大核心并发控制机制)
  - [二、 操作类型拆解](#二-操作类型拆解)
  - [三、 RC 与 RR 隔离级别下的核心行为对比](#三-rc-与-rr-隔离级别下的核心行为对比)
  - [四、 结论](#四-结论)

</details>

## 一、 两大核心并发控制机制

MySQL (InnoDB) 的并发控制，主要依赖于两大核心机制的协同工作：**锁** 和 **多版本并发控制 (MVCC)**。

*   **锁 (Locking)**: 主要用于解决“写-写”冲突。当一个事务需要修改数据时，会获取锁来阻止其他事务进行冲突的写操作。
*   **MVCC**: 主要用于解决“读-写”冲突。它使得读操作在大多数情况下无需等待写操作，极大地提升了并发性能。

不同的隔离级别，正是通过调整这两种机制的具体行为来实现的。

## 二、 操作类型拆解<!--  -->

在分析隔离级别前，我们先将数据库操作进行拆分：

*   **写操作 (`INSERT`, `DELETE`, `UPDATE`)**:
    这些操作总是会加 **排他锁 (X Lock)**，因为它们要修改数据。

*   **读操作 (`SELECT`)**:
    *   **快照读 (Snapshot Read)**: 普通的`SELECT`语句。它不加锁，而是利用 **MVCC** 机制来读取数据的历史版本，以实现非阻塞读取。
    *   **当前读 (Current Read)**: `SELECT ... FOR SHARE` 或 `SELECT ... FOR UPDATE`。它会放弃MVCC，而去读取数据库最新的、已提交的版本，并在此过程中**加锁**。
        *   `FOR SHARE`: 加 **共享锁 (S Lock)**，允许其他事务也加S锁读取，但阻止写操作。
        *   `FOR UPDATE`: 加 **排他锁 (X Lock)**，阻止其他任何读、写锁。

## 三、 RC 与 RR 隔离级别下的核心行为对比

理解了上述基础后，RC和RR的全部区别，都可以通过下面这张表格来清晰地展现：

| 操作类型 | RC (读已提交) 的行为 | RR (可重复读) 的行为 | 核心区别总结 |
| :--- | :--- | :--- | :--- |
| **快照读**<br/>(`SELECT`) | **每次查询都创建新Read View**。因此总能读到其他已提交事务的最新数据。 | **仅在第一次查询时创建Read View**，并在整个事务中复用。因此事务期间的读取结果总是一致的。 | **Read View的创建时机不同**，这是导致“不可重复读”现象能否出现的根本原因。 |
| **当前读 (加锁查询)**<br/>(`SELECT...FOR SHARE`)<br/>(`SELECT...FOR UPDATE`) | **加记录锁 (Record Lock)**，即标准的**行锁**。只锁定满足条件的行本身，不锁定间隙。 | **加临键锁 (Next-Key Lock)**。这是一种复合锁，既包含**行锁**，也包含**间隙锁 (Gap Lock)**。 | **锁的范围不同**。RR使用临键锁来锁定记录及其周围的间隙，以防止“幻读”。 |
| **写操作**<br/>(`INSERT`, `DELETE`, `UPDATE`) | **加记录锁 (Record Lock)**，即**行级排他锁**。 | **加临键锁 (Next-Key Lock)**，即**临键排他锁**。 | 同“当前读”，RR通过锁定间隙来保证事务的一致性，防止幻行插入。 |

## 四、 结论

*   **RC (读已提交)**:
    *   **优点**: 锁的粒度更小（只有行锁），并发性能相对更高。快照读总能读到最新已提交数据。
    *   **缺点**: MVCC机制无法解决“不可重复读”，锁机制也无法解决“幻读”。

*   **RR (可重复读)**:
    *   **优点**: 通过**复用Read View**解决了“不可重复读”，通过**临键锁**解决了“幻读”，提供了更高的数据一致性保证。
    *   **缺点**: 临键锁可能锁定不必要的范围，降低了一定的并发性能。

MySQL默认采用RR隔离级别，是在数据一致性和并发性能之间做出的一个经典权衡。
